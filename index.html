<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapports Hebdomadaires - Gestion de Chantier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @media print {
            /* Masquer tout le contenu normal */
            .no-print,
            #workersContainer,
            .bg-white.rounded-lg.shadow-md,
            .grid.grid-cols-1.lg\:grid-cols-2,
            #observationsContainer,
            .bg-gradient-to-r.from-orange-50.to-amber-50 {
                display: none !important;
            }
            
            /* Afficher uniquement la fiche de pointage */
            #printSheet {
                display: block !important;
            }
            
            body {
                background: white;
                margin: 0;
                padding: 5mm;
                font-family: Arial, sans-serif;
                font-size: 10pt;
            }
            
            @page {
                size: A4;
                margin: 5mm;
            }
            
            .container {
                max-width: 100% !important;
                padding: 0 !important;
            }
            
            #previsionnelWatermark.active {
                display: block !important;
            }
            
            /* Style de la fiche de pointage */
            .print-sheet {
                width: 100%;
                border: 2px solid black;
            }
            
            .print-header {
                display: grid;
                grid-template-columns: 1fr 2fr 1fr;
                border-bottom: 2px solid black;
            }
            
            .print-header > div {
                padding: 8px;
                border-right: 2px solid black;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                text-align: center;
            }
            
            .print-header > div:last-child {
                border-right: none;
            }
            
            .print-header .semaine {
                font-weight: bold;
                font-size: 10pt;
            }
            
            .print-header .title {
                font-weight: bold;
                font-size: 12pt;
            }
            
            .print-header .dates {
                font-size: 9pt;
            }
            
            .print-header .nom-label {
                font-size: 9pt;
            }
            
            .print-header .nom-value {
                font-weight: bold;
                font-size: 11pt;
            }
            
            /* Tableau principal */
            .print-table {
                width: 100%;
                border-collapse: collapse;
            }
            
            .print-table th,
            .print-table td {
                border: 1px solid black;
                padding: 4px 2px;
                text-align: center;
                font-size: 9pt;
            }
            
            .print-table th {
                font-weight: bold;
                background-color: white;
            }
            
            .print-table .chantier-col {
                text-align: left;
                width: 100px;
                font-size: 8pt;
            }
            
            .print-table .day-col {
                width: 50px;
                font-size: 8pt;
            }
            
            .print-table .total-col {
                width: 50px;
                font-weight: bold;
                font-size: 9pt;
            }
            
            .print-table .section-header {
                background-color: #f0f0f0;
                font-weight: bold;
                text-align: left;
                padding: 4px 8px;
            }
            
            .print-table .total-row {
                font-weight: bold;
            }
            
            .print-table .total-row .total-value {
                color: red;
            }
            
            .print-table .empty-row {
                height: 30px;
            }
            
            /* Section observations */
            .print-observations {
                border-top: 2px solid black;
                padding: 8px;
                min-height: 100px;
            }
            
            .print-observations-title {
                font-weight: bold;
                margin-bottom: 8px;
                font-size: 10pt;
            }
            
            .print-observations-content {
                white-space: pre-wrap;
                font-size: 10pt;
                font-style: italic;
                text-align: center;
            }
            
            /* Section signatures */
            .print-footer {
                display: grid;
                grid-template-columns: 1fr 1fr;
                border-top: 2px solid black;
            }
            
            .print-footer > div {
                padding: 8px;
                border-right: 2px solid black;
                min-height: 60px;
            }
            
            .print-footer > div:last-child {
                border-right: none;
            }
            
            .print-footer-label {
                font-weight: bold;
                font-size: 9pt;
                margin-bottom: 4px;
            }
            
            /* Saut de page */
            .print-break {
                page-break-before: always;
            }
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
        }
        
        #previsionnelWatermark {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 100px;
            font-weight: bold;
            color: rgba(255, 0, 0, 0.15);
            pointer-events: none;
            z-index: 9999;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 20px;
        }
        
        /* Optimisation pour smartphone */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }
            
            .container {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
                padding-top: 0.5rem !important;
                padding-bottom: 0.5rem !important;
            }
            
            /* En-tête plus compact */
            h1 {
                font-size: 1.5rem !important;
            }
            
            h2 {
                font-size: 1.125rem !important;
            }
            
            /* Boutons en-tête empilés */
            .flex.items-center.justify-between {
                flex-direction: column;
                align-items: flex-start !important;
            }
            
            .flex.space-x-2 {
                width: 100%;
                margin-top: 1rem;
            }
            
            .flex.space-x-2 button {
                flex: 1;
                justify-content: center;
            }
            
            /* Grille configuration semaine en colonne */
            .grid.grid-cols-1.md\:grid-cols-3 {
                grid-template-columns: 1fr !important;
            }
            
            /* Cartes ouvriers */
            .bg-white.rounded-lg {
                padding: 0.75rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            /* Nom et rôle de l'ouvrier */
            .flex.items-center.justify-between.mb-4 {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 0.5rem;
            }
            
            /* Chantiers - Layout optimisé pour mobile */
            .site-card {
                padding: 0.5rem !important;
            }
            
            .site-header-wrapper {
                flex-direction: row !important;
                align-items: center !important;
                margin-bottom: 0.5rem !important;
            }
            
            .site-name {
                flex: 1 !important;
                padding-top: 0 !important;
                margin-bottom: 0 !important;
            }
            
            .site-delete-btn {
                margin-top: 0 !important;
                flex-shrink: 0;
            }
            
            .site-days-grid {
                width: 100% !important;
            }
            
            /* Grille des jours plus compacte */
            .grid.grid-cols-5 {
                gap: 0.25rem !important;
            }
            
            .grid.grid-cols-5 input {
                font-size: 0.875rem !important;
                padding: 0.375rem 0.25rem !important;
            }
            
            .grid.grid-cols-5 label {
                font-size: 0.75rem !important;
            }
            
            /* Inputs et selects plus grands pour mobile */
            input, select, textarea {
                font-size: 16px !important; /* Évite le zoom automatique sur iOS */
                padding: 0.5rem !important;
            }
            
            input[type="number"] {
                padding: 0.375rem 0.25rem !important;
            }
            
            /* Boutons plus grands et tactiles */
            button {
                min-height: 44px; /* Taille minimale recommandée pour le tactile */
                padding: 0.625rem 1rem !important;
            }
            
            /* Icônes légèrement plus grandes */
            i[data-lucide] {
                width: 20px !important;
                height: 20px !important;
            }
            
            /* Tableaux responsive */
            table {
                font-size: 0.75rem !important;
            }
            
            th, td {
                padding: 0.5rem 0.25rem !important;
            }
            
            /* Conducteur de la semaine */
            #driverSelectionRow {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .grid.grid-cols-6 {
                min-width: 100%;
            }
            
            /* Modal plein écran sur mobile */
            #addWorkerModal > div {
                max-width: 95% !important;
                margin: 1rem !important;
            }
            
            /* Tabs du modal */
            .flex.border-b button {
                flex: 1;
                font-size: 0.875rem !important;
            }
            
            /* Espacements réduits */
            .space-y-6 > * + * {
                margin-top: 0.75rem !important;
            }
            
            .mb-6 {
                margin-bottom: 0.75rem !important;
            }
            
            .p-6 {
                padding: 0.75rem !important;
            }
            
            /* Scroll horizontal pour les grilles de jours si nécessaire */
            .flex-1.grid.grid-cols-5 {
                min-width: 280px;
            }
            
            /* Badge rôle */
            .rounded-full {
                font-size: 0.75rem !important;
                padding: 0.25rem 0.625rem !important;
            }
            
            /* Améliorer la lisibilité des totaux */
            .text-right.text-sm {
                font-size: 0.875rem !important;
                font-weight: 600 !important;
            }
        }
        
        /* Très petits écrans (< 375px) */
        @media (max-width: 374px) {
            h1 {
                font-size: 1.25rem !important;
            }
            
            .grid.grid-cols-5 {
                grid-template-columns: repeat(5, minmax(50px, 1fr)) !important;
            }
            
            .grid.grid-cols-5 input {
                font-size: 0.75rem !important;
                padding: 0.25rem 0.125rem !important;
            }
            
            .grid.grid-cols-5 label {
                font-size: 0.625rem !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Filigrane Prévisionnel -->
    <div id="previsionnelWatermark">PRÉVISIONNEL</div>
    
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- En-tête -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center space-x-3">
                    <i data-lucide="clipboard-list" class="text-blue-600" style="width: 32px; height: 32px;"></i>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Rapports Hebdomadaires</h1>
                        <p class="text-gray-600">Gestion des heures de chantier</p>
                    </div>
                </div>
                <div class="flex space-x-2 no-print">
                    <button id="previsionnelBtn" onclick="togglePrevisionnel()" class="flex items-center space-x-2 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                        <i data-lucide="file-text" style="width: 20px; height: 20px;"></i>
                        <span>Prévisionnel</span>
                    </button>
                    <button onclick="printReport()" class="flex items-center space-x-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                        <i data-lucide="printer" style="width: 20px; height: 20px;"></i>
                        <span>Imprimer / PDF</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Configuration de la semaine -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6 no-print">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center space-x-2">
                <i data-lucide="calendar" style="width: 24px; height: 24px;"></i>
                <span>Configuration de la semaine</span>
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Semaine</label>
                    <input type="week" id="weekSelector" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Période</label>
                    <div id="weekDisplay" class="px-4 py-2 bg-gray-100 rounded-lg text-gray-700 font-medium h-[42px] flex items-center">-</div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Chef de chantier</label>
                    <select id="foremanSelector" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Sélectionner...</option>
                    </select>
                </div>
            </div>
            <div class="mt-4">
                <button onclick="showAddWorkerModal()" class="flex items-center space-x-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                    <i data-lucide="user-plus" style="width: 20px; height: 20px;"></i>
                    <span>Ajouter un ouvrier</span>
                </button>
            </div>
        </div>

        <!-- Informations pour l'impression -->
        <div class="hidden print:block bg-white p-6 mb-6">
            <div class="text-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Rapport Hebdomadaire</h2>
                <p class="text-gray-600 mt-2">Période : <span id="printWeekDisplay"></span></p>
                <p class="text-gray-600">Chef de chantier : <span id="printForemanDisplay"></span></p>
            </div>
        </div>

        <!-- Sélection du conducteur par jour -->
        <div class="bg-gradient-to-r from-orange-50 to-amber-50 rounded-lg shadow-lg p-6 mb-6 border-2 border-orange-300">
            <h2 class="text-xl font-bold text-orange-800 mb-4 flex items-center space-x-2">
                <i data-lucide="car" class="text-orange-600" style="width: 24px; height: 24px;"></i>
                <span>Conducteur de la semaine</span>
            </h2>
            <div id="driverSelectionRow" class="grid grid-cols-5 gap-4">
                <!-- Les sélecteurs de conducteur seront générés ici -->
            </div>
        </div>

        <!-- Saisie par ouvrier -->
        <div id="workersContainer" class="space-y-6 mb-6">
            <!-- Les cartes des ouvriers seront générées ici -->
        </div>

        <!-- Récapitulatifs -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Total par ouvrier -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center space-x-2">
                    <i data-lucide="users" style="width: 24px; height: 24px;"></i>
                    <span>Total par ouvrier</span>
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-100 border-b-2 border-gray-300">
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Ouvrier</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Total heures</th>
                            </tr>
                        </thead>
                        <tbody id="workerTotalTable">
                            <tr>
                                <td colspan="2" class="px-4 py-4 text-center text-gray-500">Aucune donnée</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="bg-blue-50 border-t-2 border-blue-300 font-bold">
                                <td class="px-4 py-3 text-left">TOTAL GÉNÉRAL</td>
                                <td class="px-4 py-3 text-right" id="grandTotal">0h</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Total par chantier -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center space-x-2">
                    <i data-lucide="building-2" style="width: 24px; height: 24px;"></i>
                    <span>Total par chantier</span>
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-100 border-b-2 border-gray-300">
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Chantier</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Total heures</th>
                            </tr>
                        </thead>
                        <tbody id="siteTotalTable">
                            <tr>
                                <td colspan="2" class="px-4 py-4 text-center text-gray-500">Aucune donnée</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="bg-blue-50 border-t-2 border-blue-300 font-bold">
                                <td class="px-4 py-3 text-left">TOTAL GÉNÉRAL</td>
                                <td class="px-4 py-3 text-right" id="grandTotalSites">0h</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Observations -->
        <div id="observationsContainer" class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center space-x-2">
                <i data-lucide="message-square" style="width: 24px; height: 24px;"></i>
                <span>Observations</span>
            </h2>
            <textarea 
                id="observations" 
                rows="4" 
                placeholder="Ajouter des commentaires ou observations pour cette semaine..."
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-vertical"
            ></textarea>
            <div id="observationsPrint" class="hidden print:block mt-2 text-gray-700 whitespace-pre-wrap"></div>
        </div>
    </div>

    <!-- Fiche de pointage pour l'impression -->
    <div id="printSheet" style="display: none;">
        <!-- Le contenu sera généré dynamiquement par JavaScript -->
    </div>

    <!-- Modal Ajouter un ouvrier -->
    <div id="addWorkerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 no-print">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Ajouter un ouvrier au rapport</h3>
            
            <!-- Onglets -->
            <div class="flex mb-4 border-b border-gray-200">
                <button type="button" id="tabExisting" onclick="switchTab('existing')" class="flex-1 py-2 px-4 text-center font-medium border-b-2 border-blue-600 text-blue-600">
                    Sélectionner
                </button>
                <button type="button" id="tabNew" onclick="switchTab('new')" class="flex-1 py-2 px-4 text-center font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    Créer nouveau
                </button>
            </div>
            
            <form id="addWorkerForm" class="space-y-4">
                <!-- Sélection d'un ouvrier existant -->
                <div id="existingWorkerSection">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sélectionner un ouvrier *</label>
                        <select id="workerSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Choisir...</option>
                        </select>
                    </div>
                </div>
                
                <!-- Création d'un nouvel ouvrier -->
                <div id="newWorkerSection" class="hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Prénom *</label>
                        <input type="text" id="newWorkerFirstName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nom *</label>
                        <input type="text" id="newWorkerLastName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                
                <div class="flex space-x-2">
                    <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                        Ajouter
                    </button>
                    <button type="button" onclick="hideAddWorkerModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        lucide.createIcons();
    </script>
</body>
</html>
