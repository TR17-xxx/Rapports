<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rapports Hebdomadaires - Gestion de Chantier</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background: white;
                font-size: 11px;
            }
            .print-break {
                page-break-before: always;
            }
            #previsionnelWatermark.active {
                display: block !important;
            }
            
            /* Optimisation de l'espace pour l'impression */
            .container {
                max-width: 100% !important;
                padding: 10px !important;
            }
            
            h1 {
                font-size: 20px !important;
                margin-bottom: 5px !important;
            }
            
            h2 {
                font-size: 16px !important;
                margin-bottom: 8px !important;
            }
            
            h3 {
                font-size: 14px !important;
            }
            
            .bg-white {
                box-shadow: none !important;
                padding: 8px !important;
                margin-bottom: 8px !important;
            }
            
            .rounded-lg {
                border-radius: 4px !important;
            }
            
            /* Réduire les espacements */
            .mb-6 {
                margin-bottom: 8px !important;
            }
            
            .mb-4 {
                margin-bottom: 6px !important;
            }
            
            .p-6 {
                padding: 8px !important;
            }
            
            .p-4 {
                padding: 6px !important;
            }
            
            .space-y-6 > * + * {
                margin-top: 8px !important;
            }
            
            /* Tableaux plus compacts */
            table {
                font-size: 10px !important;
            }
            
            th, td {
                padding: 4px 8px !important;
            }
            
            /* Inputs plus petits et sans bordures */
            input, select, textarea {
                font-size: 11px !important;
                padding: 3px 6px !important;
                border: none !important;
                background: transparent !important;
                box-shadow: none !important;
                -webkit-appearance: none !important;
                -moz-appearance: none !important;
                appearance: none !important;
                text-align: center !important;
            }
            
            input[type="text"] {
                text-align: left !important;
            }
            
            /* Masquer les flèches des selects et inputs number */
            select {
                background-image: none !important;
            }
            
            input[type="number"]::-webkit-inner-spin-button,
            input[type="number"]::-webkit-outer-spin-button {
                display: none !important;
            }
            
            /* Supprimer toutes les bordures */
            .border, .border-2, .border-gray-200, .border-gray-300, .border-orange-300 {
                border: none !important;
            }
            
            /* Supprimer les fonds colorés sauf pour les en-têtes */
            .bg-gray-50, .bg-blue-50, .bg-orange-50, .bg-amber-50 {
                background: transparent !important;
            }
            
            .bg-gray-100 {
                background: #f5f5f5 !important;
            }
            
            /* Garder uniquement les bordures des tableaux */
            table {
                border-collapse: collapse !important;
            }
            
            table th {
                border-bottom: 2px solid #333 !important;
                background: #f5f5f5 !important;
            }
            
            table td {
                border-bottom: 1px solid #ddd !important;
            }
            
            table tfoot td {
                border-top: 2px solid #333 !important;
                border-bottom: none !important;
            }
            
            /* Grilles optimisées */
            .grid {
                gap: 6px !important;
            }
            
            /* Badges plus petits */
            .rounded-full {
                font-size: 9px !important;
                padding: 2px 8px !important;
            }
            
            /* Supprimer les ombres */
            .shadow-md, .shadow-lg, .shadow-sm {
                box-shadow: none !important;
            }
            
            /* Simplifier les cartes d'ouvriers */
            #workersContainer > div {
                border: 1px solid #ddd !important;
                margin-bottom: 12px !important;
            }
            
            /* Ligne de séparation pour les chantiers */
            #workersContainer .bg-gray-50 {
                border-top: 1px solid #eee !important;
                padding-top: 6px !important;
                margin-top: 6px !important;
            }
            
            /* Section conducteur de la semaine */
            #driverSelectionRow {
                text-align: center !important;
            }
            
            #driverSelectionRow label {
                font-size: 12px !important;
                font-weight: bold !important;
                text-align: center !important;
            }
            
            #driverSelectionRow select {
                font-size: 11px !important;
                text-align: center !important;
            }
            
            /* Masquer "Total chantier" en impression */
            .print\:hidden {
                display: none !important;
            }
            
            /* Améliorer les labels des jours */
            .grid label {
                text-align: center !important;
            }
            
            /* Réduire les espaces dans les grilles de jours */
            .grid-cols-5 {
                gap: 2px !important;
            }
            
            /* Ajouter des séparateurs verticaux entre les jours */
            .grid-cols-5 > div:not(:last-child) {
                border-right: 1px solid #ddd !important;
                padding-right: 4px !important;
            }
            
            .grid-cols-5 > div {
                padding-left: 4px !important;
            }
            
            /* Optimiser l'affichage du nom de chantier */
            .site-header {
                display: flex !important;
                align-items: center !important;
                margin-bottom: 4px !important;
            }
            
            .site-name {
                font-weight: bold !important;
                margin-right: 10px !important;
                min-width: 100px !important;
            }
        }
        
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            opacity: 1;
        }
        
        #previsionnelWatermark {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) rotate(-45deg);
            font-size: 100px;
            font-weight: bold;
            color: rgba(255, 0, 0, 0.15);
            pointer-events: none;
            z-index: 9999;
            white-space: nowrap;
            text-transform: uppercase;
            letter-spacing: 20px;
        }
        
        /* Optimisation pour smartphone */
        @media (max-width: 768px) {
            body {
                font-size: 14px;
            }
            
            .container {
                padding-left: 0.5rem !important;
                padding-right: 0.5rem !important;
                padding-top: 0.5rem !important;
                padding-bottom: 0.5rem !important;
            }
            
            /* En-tête plus compact */
            h1 {
                font-size: 1.5rem !important;
            }
            
            h2 {
                font-size: 1.125rem !important;
            }
            
            /* Boutons en-tête empilés */
            .flex.items-center.justify-between {
                flex-direction: column;
                align-items: flex-start !important;
            }
            
            .flex.space-x-2 {
                width: 100%;
                margin-top: 1rem;
            }
            
            .flex.space-x-2 button {
                flex: 1;
                justify-content: center;
            }
            
            /* Grille configuration semaine en colonne */
            .grid.grid-cols-1.md\:grid-cols-3 {
                grid-template-columns: 1fr !important;
            }
            
            /* Cartes ouvriers */
            .bg-white.rounded-lg {
                padding: 0.75rem !important;
                margin-bottom: 0.75rem !important;
            }
            
            /* Nom et rôle de l'ouvrier */
            .flex.items-center.justify-between.mb-4 {
                flex-direction: column;
                align-items: flex-start !important;
                gap: 0.5rem;
            }
            
            /* Chantiers - Layout optimisé pour mobile */
            .site-card {
                padding: 0.5rem !important;
            }
            
            .site-header-wrapper {
                flex-direction: row !important;
                align-items: center !important;
                margin-bottom: 0.5rem !important;
            }
            
            .site-name {
                flex: 1 !important;
                padding-top: 0 !important;
                margin-bottom: 0 !important;
            }
            
            .site-delete-btn {
                margin-top: 0 !important;
                flex-shrink: 0;
            }
            
            .site-days-grid {
                width: 100% !important;
            }
            
            /* Grille des jours plus compacte */
            .grid.grid-cols-5 {
                gap: 0.25rem !important;
            }
            
            .grid.grid-cols-5 input {
                font-size: 0.875rem !important;
                padding: 0.375rem 0.25rem !important;
            }
            
            .grid.grid-cols-5 label {
                font-size: 0.75rem !important;
            }
            
            /* Inputs et selects plus grands pour mobile */
            input, select, textarea {
                font-size: 16px !important; /* Évite le zoom automatique sur iOS */
                padding: 0.5rem !important;
            }
            
            input[type="number"] {
                padding: 0.375rem 0.25rem !important;
            }
            
            /* Boutons plus grands et tactiles */
            button {
                min-height: 44px; /* Taille minimale recommandée pour le tactile */
                padding: 0.625rem 1rem !important;
            }
            
            /* Icônes légèrement plus grandes */
            i[data-lucide] {
                width: 20px !important;
                height: 20px !important;
            }
            
            /* Tableaux responsive */
            table {
                font-size: 0.75rem !important;
            }
            
            th, td {
                padding: 0.5rem 0.25rem !important;
            }
            
            /* Conducteur de la semaine */
            #driverSelectionRow {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .grid.grid-cols-6 {
                min-width: 100%;
            }
            
            /* Modal plein écran sur mobile */
            #addWorkerModal > div {
                max-width: 95% !important;
                margin: 1rem !important;
            }
            
            /* Tabs du modal */
            .flex.border-b button {
                flex: 1;
                font-size: 0.875rem !important;
            }
            
            /* Espacements réduits */
            .space-y-6 > * + * {
                margin-top: 0.75rem !important;
            }
            
            .mb-6 {
                margin-bottom: 0.75rem !important;
            }
            
            .p-6 {
                padding: 0.75rem !important;
            }
            
            /* Scroll horizontal pour les grilles de jours si nécessaire */
            .flex-1.grid.grid-cols-5 {
                min-width: 280px;
            }
            
            /* Badge rôle */
            .rounded-full {
                font-size: 0.75rem !important;
                padding: 0.25rem 0.625rem !important;
            }
            
            /* Améliorer la lisibilité des totaux */
            .text-right.text-sm {
                font-size: 0.875rem !important;
                font-weight: 600 !important;
            }
        }
        
        /* Très petits écrans (< 375px) */
        @media (max-width: 374px) {
            h1 {
                font-size: 1.25rem !important;
            }
            
            .grid.grid-cols-5 {
                grid-template-columns: repeat(5, minmax(50px, 1fr)) !important;
            }
            
            .grid.grid-cols-5 input {
                font-size: 0.75rem !important;
                padding: 0.25rem 0.125rem !important;
            }
            
            .grid.grid-cols-5 label {
                font-size: 0.625rem !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Filigrane Prévisionnel -->
    <div id="previsionnelWatermark">PRÉVISIONNEL</div>
    
    <div class="container mx-auto px-4 py-8 max-w-7xl">
        <!-- En-tête -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <div class="flex items-center space-x-3">
                    <i data-lucide="clipboard-list" class="text-blue-600" style="width: 32px; height: 32px;"></i>
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Rapports Hebdomadaires</h1>
                        <p class="text-gray-600">Gestion des heures de chantier</p>
                    </div>
                </div>
                <div class="flex space-x-2 no-print">
                    <button id="previsionnelBtn" onclick="togglePrevisionnel()" class="flex items-center space-x-2 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                        <i data-lucide="file-text" style="width: 20px; height: 20px;"></i>
                        <span>Prévisionnel</span>
                    </button>
                    <button onclick="window.print()" class="flex items-center space-x-2 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                        <i data-lucide="printer" style="width: 20px; height: 20px;"></i>
                        <span>Imprimer / PDF</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Configuration de la semaine -->
        <div class="bg-white rounded-lg shadow-md p-6 mb-6 no-print">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center space-x-2">
                <i data-lucide="calendar" style="width: 24px; height: 24px;"></i>
                <span>Configuration de la semaine</span>
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Semaine</label>
                    <input type="week" id="weekSelector" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Période</label>
                    <div id="weekDisplay" class="px-4 py-2 bg-gray-100 rounded-lg text-gray-700 font-medium h-[42px] flex items-center">-</div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Chef de chantier</label>
                    <select id="foremanSelector" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <option value="">Sélectionner...</option>
                    </select>
                </div>
            </div>
            <div class="mt-4">
                <button onclick="showAddWorkerModal()" class="flex items-center space-x-2 bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">
                    <i data-lucide="user-plus" style="width: 20px; height: 20px;"></i>
                    <span>Ajouter un ouvrier</span>
                </button>
            </div>
        </div>

        <!-- Informations pour l'impression -->
        <div class="hidden print:block bg-white p-6 mb-6">
            <div class="text-center mb-4">
                <h2 class="text-2xl font-bold text-gray-800">Rapport Hebdomadaire</h2>
                <p class="text-gray-600 mt-2">Période : <span id="printWeekDisplay"></span></p>
                <p class="text-gray-600">Chef de chantier : <span id="printForemanDisplay"></span></p>
            </div>
        </div>

        <!-- Sélection du conducteur par jour -->
        <div class="bg-gradient-to-r from-orange-50 to-amber-50 rounded-lg shadow-lg p-6 mb-6 border-2 border-orange-300">
            <h2 class="text-xl font-bold text-orange-800 mb-4 flex items-center space-x-2">
                <i data-lucide="car" class="text-orange-600" style="width: 24px; height: 24px;"></i>
                <span>Conducteur de la semaine</span>
            </h2>
            <div id="driverSelectionRow" class="grid grid-cols-5 gap-4">
                <!-- Les sélecteurs de conducteur seront générés ici -->
            </div>
        </div>

        <!-- Saisie par ouvrier -->
        <div id="workersContainer" class="space-y-6 mb-6">
            <!-- Les cartes des ouvriers seront générées ici -->
        </div>

        <!-- Récapitulatifs -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
            <!-- Total par ouvrier -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center space-x-2">
                    <i data-lucide="users" style="width: 24px; height: 24px;"></i>
                    <span>Total par ouvrier</span>
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-100 border-b-2 border-gray-300">
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Ouvrier</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Total heures</th>
                            </tr>
                        </thead>
                        <tbody id="workerTotalTable">
                            <tr>
                                <td colspan="2" class="px-4 py-4 text-center text-gray-500">Aucune donnée</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="bg-blue-50 border-t-2 border-blue-300 font-bold">
                                <td class="px-4 py-3 text-left">TOTAL GÉNÉRAL</td>
                                <td class="px-4 py-3 text-right" id="grandTotal">0h</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>

            <!-- Total par chantier -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center space-x-2">
                    <i data-lucide="building-2" style="width: 24px; height: 24px;"></i>
                    <span>Total par chantier</span>
                </h2>
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead>
                            <tr class="bg-gray-100 border-b-2 border-gray-300">
                                <th class="px-4 py-3 text-left text-sm font-semibold text-gray-700">Chantier</th>
                                <th class="px-4 py-3 text-right text-sm font-semibold text-gray-700">Total heures</th>
                            </tr>
                        </thead>
                        <tbody id="siteTotalTable">
                            <tr>
                                <td colspan="2" class="px-4 py-4 text-center text-gray-500">Aucune donnée</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr class="bg-blue-50 border-t-2 border-blue-300 font-bold">
                                <td class="px-4 py-3 text-left">TOTAL GÉNÉRAL</td>
                                <td class="px-4 py-3 text-right" id="grandTotalSites">0h</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- Observations -->
        <div id="observationsContainer" class="bg-white rounded-lg shadow-md p-6">
            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center space-x-2">
                <i data-lucide="message-square" style="width: 24px; height: 24px;"></i>
                <span>Observations</span>
            </h2>
            <textarea 
                id="observations" 
                rows="4" 
                placeholder="Ajouter des commentaires ou observations pour cette semaine..."
                class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-vertical"
            ></textarea>
            <div id="observationsPrint" class="hidden print:block mt-2 text-gray-700 whitespace-pre-wrap"></div>
        </div>
    </div>

    <!-- Modal Ajouter un ouvrier -->
    <div id="addWorkerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 no-print">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
            <h3 class="text-xl font-bold text-gray-800 mb-4">Ajouter un ouvrier au rapport</h3>
            
            <!-- Onglets -->
            <div class="flex mb-4 border-b border-gray-200">
                <button type="button" id="tabExisting" onclick="switchTab('existing')" class="flex-1 py-2 px-4 text-center font-medium border-b-2 border-blue-600 text-blue-600">
                    Sélectionner
                </button>
                <button type="button" id="tabNew" onclick="switchTab('new')" class="flex-1 py-2 px-4 text-center font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                    Créer nouveau
                </button>
            </div>
            
            <form id="addWorkerForm" class="space-y-4">
                <!-- Sélection d'un ouvrier existant -->
                <div id="existingWorkerSection">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sélectionner un ouvrier *</label>
                        <select id="workerSelect" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                            <option value="">Choisir...</option>
                        </select>
                    </div>
                </div>
                
                <!-- Création d'un nouvel ouvrier -->
                <div id="newWorkerSection" class="hidden">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Prénom *</label>
                        <input type="text" id="newWorkerFirstName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Nom *</label>
                        <input type="text" id="newWorkerLastName" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                </div>
                
                <div class="flex space-x-2">
                    <button type="submit" class="flex-1 bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition">
                        Ajouter
                    </button>
                    <button type="button" onclick="hideAddWorkerModal()" class="flex-1 bg-gray-300 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-400 transition">
                        Annuler
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="app.js"></script>
    <script>
        lucide.createIcons();
    </script>
</body>
</html>
